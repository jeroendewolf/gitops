- name: Deploy demo-spring with Helm
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    k8s_namespace: default
    release_name: demo-spring
    chart_path: "{{ playbook_dir }}/../demo-spring-chart"
    image_repo: demo-spring
    image_tag: "25-1"

  tasks:
    - name: Show kube env (debug)
      ansible.builtin.command: sh -lc 'echo "KUBECONFIG=$KUBECONFIG"; ls -la ${KUBECONFIG:-/runner/.kube/config} 2>/dev/null || true'

    - name: Test kubectl access
      ansible.builtin.command: kubectl get ns

    - name: Helm upgrade/install
      ansible.builtin.command: >
        helm upgrade --install {{ release_name }} {{ chart_path }}
        --namespace {{ k8s_namespace }}
        --create-namespace
        --set image.repository={{ image_repo }}
        --set image.tag={{ image_tag }}
        --set image.pullPolicy=IfNotPresent
